<script src="//cdnjs.cloudflare.com/ajax/libs/polymer/0.5.2/polymer.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0/handlebars.min.js"></script>
<polymer-element name="togostanza-gene-attributes" attributes="gene_id">
<template>
<link rel="stylesheet" href="../assets/stanza.css">
<main id="content"></main>
</template>
<script>
  function Stanza(name, execute) {
    Polymer(name, {
      templates: {"stanza.html":"{{#if gene_attributes}}\n  <table class=\"table\">\n    <tbody>\n    <tr>\n      <th>Gene symbol</th>\n      <td>{{gene_attributes.gene_symbol.value}}</td>\n    </tr>\n    <tr>\n      <th>Locus tag</th>\n      <td>{{gene_attributes.locus_tag.value}}</td>\n    </tr>\n    <tr>\n      <th>Gene type</th>\n      <td>{{gene_attributes.gene_type_label.value}}</td>\n    </tr>\n    <tr>\n      <th>Organism</th>\n      <td><a href=\"{{gene_attributes.tax_link}}\">{{gene_attributes.organism.value}}</a></td>\n    </tr>\n    <tr>\n      <th>RefSeq</th>\n      <td><a href=\"{{gene_attributes.refseq_link}}\">{{gene_attributes.refseq_label.value}}</a></td>\n    </tr>\n    <tr>\n      <th>Position</th>\n      <td>{{gene_attributes.insdc_location.value}}</td>\n    </tr>\n    <tr>\n      <th>Strand</th>\n      <td>{{gene_attributes.stand.value}}</td>\n    </tr>\n    <tr>\n      <th>Length</th>\n      <td>{{gene_attributes.seq_length}}</td>\n    </tr>\n    </tbody>\n  </table>\n{{else}}\n  No Data.\n{{/if}}\n","stanza.rq":"DEFINE sql:select-option \"order\"\nPREFIX obo: <http://purl.obolibrary.org/obo/>\nPREFIX faldo: <http://biohackathon.org/resource/faldo#>\nPREFIX insdc:  <http://ddbj.nig.ac.jp/ontologies/sequence#>\n\nSELECT DISTINCT ?locus_tag ?gene_type_label ?seq_label ?seq_type_label ?gene_symbol\n  (REPLACE(?refseq_label,\"RefSeq:\",\"\") AS ?refseq_label) ?organism ?taxid\n  ?faldo_begin_position ?faldo_end_position ?stand ?insdc_location\n  (CONCAT(\"http://togows.dbcls.jp/entry/nucleotide/\", REPLACE(?refseq_label,\"RefSeq:\",\"\"),\"/seq/\", ?insdc_location) AS ?seqence)\nFROM <http://togogenome.org/graph/refseq/>\nFROM <http://togogenome.org/graph/so/>\nFROM <http://togogenome.org/graph/faldo/>\n{\n  {\n    SELECT DISTINCT ?gene ?locus_tag ?gene_type_label ?seq_label ?seq_type_label\n      ?refseq_label ?organism ?taxid\n      ?faldo_begin_position ?faldo_end_position ?stand ?insdc_location\n    WHERE\n    {\n      VALUES ?locus_tag { \"{{gene_id}}\" }\n      VALUES ?seq_type  { obo:SO_0000340 obo:SO_0000155 }\n      VALUES ?gene_type { obo:SO_0000704 obo:SO_0000252 obo:SO_0000253 }\n      VALUES ?faldo_stand_type { faldo:ForwardStrandPosition faldo:ReverseStrandPosition }\n\n      ?gene ?p ?locus_tag ;\n        a ?gene_type ;\n        obo:so_part_of ?seq .\n      ?gene_type rdfs:label ?gene_type_label .\n\n      #sequence\n      ?seq rdfs:label ?seq_label ;\n        a ?seq_type ;\n        rdfs:seeAlso ?refseq ;\n        insdc:organism ?organism ;\n        rdfs:seeAlso ?taxonomy .\n      ?seq_type rdfs:label ?seq_type_label .\n      ?refseq a <http://identifiers.org/refseq/> ;\n        rdfs:label ?refseq_label .\n      ?taxonomy a <http://identifiers.org/taxonomy/> ;\n        rdfs:label ?taxid .\n\n      #faldo\n      ?gene faldo:location ?faldo .\n      ?faldo insdc:location ?insdc_location ;\n        faldo:begin ?faldo_begin ;\n        faldo:end ?faldo_end .\n      ?faldo_begin faldo:position ?faldo_begin_position ;\n        rdf:type ?faldo_stand_type .\n      ?faldo_end faldo:position ?faldo_end_position .\n      ?faldo_stand_type rdfs:label ?stand .\n    }\n  }\n  OPTIONAL { ?gene insdc:gene ?gene_symbol. }\n}\n"},
      ready: function() {
        execute.bind(this)(this);
      },
      query: function(params, callback) {
        var self = this;
        var queryTemplate = Handlebars.compile(this.templates[params.template]);
        var query = queryTemplate(params.parameters);

        $.ajax({
          url: params.endpoint,
          data: {
            format: "json",
            query: query
          },
          success: function(data) {
            var rows = data.results.bindings;
            callback.bind(self)(rows);
          },
          error: function(xhr, status, err) {
            // TODO
          }
        });
      },
      render: function(params) {
        var htmlTemplate = Handlebars.compile(this.templates[params.template]);
        var htmlPartial = htmlTemplate(params.parameters);
        this.$.content.innerHTML = htmlPartial;
      }
    });
  }
  Stanza("togostanza-gene-attributes", function(params) {
  this.query({
    endpoint: "http://togogenome.org/sparql",
    template: "stanza.rq",
    parameters: params
  }, function(rows) {
    rows.forEach(function(row) {
      row.tax_link = "http://identifiers.org/taxonomy/" + row.taxid.value.split(":").slice(-1)[0];
      row.refseq_link = "http://identifiers.org/refseq/" + row.refseq_label.value.split(":").slice(-1)[0];
    });
    this.render({
      template: "stanza.html",
      parameters: {
        gene_attributes: rows[0]
      }
    });
  });
});

</script>
</polymer-element>
